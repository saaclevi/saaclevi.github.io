<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimório de Rituais</title>
    
    <!-- Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts para uma tipografia mais elegante -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              serif: ['Cinzel', 'serif'],
            },
            colors: {
              'brand-sangue': '#8B0000',
              'brand-morte': '#4B0082',
              'brand-conhecimento': '#00008B',
              'brand-energia': '#FFD700',
              'brand-medo': '#2F4F4F',
              'brand-varia': '#696969',
            }
          }
        }
      }
    </script>
    <style>
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .ritual-card-enter {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .ritual-card-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">

        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-serif font-bold text-gray-100 tracking-wider">Grimório de Rituais</h1>
            <p class="text-gray-400 mt-2">Um compêndio interativo de conhecimento paranormal.</p>
        </header>

        <!-- Controles -->
        <div class="sticky top-0 z-10 bg-gray-900 bg-opacity-80 backdrop-blur-sm py-4 mb-6">
            <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                <!-- Ordenação -->
                <div class="relative w-full sm:w-auto">
                    <select id="sort-order" class="w-full sm:w-56 appearance-none bg-gray-800 border border-gray-700 text-white py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-gray-700 focus:border-purple-500 transition">
                        <option value="alphabetical">Ordem: Alfabética</option>
                        <option value="level">Ordem: Círculo</option>
                        <option value="element">Ordem: Elemento</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>

                <!-- Botões de Filtro -->
                <div class="flex gap-4 w-full sm:w-auto">
                    <button id="filter-button" class="flex-1 sm:flex-none w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                        Filtros
                    </button>
                    <button id="learned-toggle" class="flex-1 sm:flex-none w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
                        Aprendidos
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Rituais -->
        <div id="ritual-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Rituais serão injetados aqui pelo JavaScript -->
        </div>
        
        <div id="loading" class="text-center py-10">
            <p class="text-xl text-gray-400">Carregando rituais...</p>
        </div>

    </div>

    <!-- Modal de Filtros -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Filtros</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="filter-options" class="space-y-6">
                <!-- Opções de filtro serão injetadas aqui -->
            </div>
            <div class="mt-6 flex gap-4">
                <button id="apply-filters" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">Aplicar</button>
                <button id="clear-filters" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Limpar Filtros</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Categoria -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-md">
            <h2 class="text-xl font-bold text-white mb-4">Editar Categoria</h2>
            <input type="text" id="category-input" class="w-full bg-gray-700 text-white rounded-lg p-2 border border-gray-600 focus:outline-none focus:border-purple-500" placeholder="Ex: Combate, Suporte, Utilidade...">
            <div class="mt-4 flex gap-4">
                <button id="save-category" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">Salvar</button>
                <button id="cancel-category" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIÁVEIS GLOBAIS E ESTADO DA APLICAÇÃO ---
            let allRituals = [];
            let learnedRituals = new Set();
            let customCategories = {};
            
            let currentSort = 'alphabetical';
            let activeFilters = {};
            let showOnlyLearned = false;

            // --- ELEMENTOS DO DOM ---
            const ritualList = document.getElementById('ritual-list');
            const loadingIndicator = document.getElementById('loading');
            const sortOrderSelect = document.getElementById('sort-order');
            const filterButton = document.getElementById('filter-button');
            const learnedToggle = document.getElementById('learned-toggle');
            const filterModal = document.getElementById('filter-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const applyFiltersButton = document.getElementById('apply-filters');
            const clearFiltersButton = document.getElementById('clear-filters');
            const categoryModal = document.getElementById('category-modal');
            const categoryInput = document.getElementById('category-input');
            const saveCategoryButton = document.getElementById('save-category');
            const cancelCategoryButton = document.getElementById('cancel-category');
            
            let currentRitualForCategory = null;

            // --- CORES DOS ELEMENTOS ---
            const elementColors = {
                'SANGUE': 'border-brand-sangue',
                'MORTE': 'border-brand-morte',
                'CONHECIMENTO': 'border-brand-conhecimento',
                'ENERGIA': 'border-brand-energia',
                'MEDO': 'border-brand-medo',
                'VARIA': 'border-brand-varia',
            };
            const elementTextColors = {
                'SANGUE': 'text-red-400',
                'MORTE': 'text-purple-400',
                'CONHECIMENTO': 'text-blue-400',
                'ENERGIA': 'text-yellow-400',
                'MEDO': 'text-teal-400',
                'VARIA': 'text-gray-400',
            };

            // --- CARREGAMENTO E INICIALIZAÇÃO ---
            
            // Função para carregar os dados do JSON
            async function loadRituals() {
                try {
                    const response = await fetch('rituais.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    allRituals = await response.json();
                    initialize();
                } catch (error) {
                    console.error("Não foi possível carregar o arquivo rituais.json:", error);
                    ritualList.innerHTML = `<p class="text-red-500 col-span-full text-center">Erro ao carregar os rituais. Verifique se o arquivo 'rituais.json' está na mesma pasta.</p>`;
                    loadingIndicator.style.display = 'none';
                }
            }
            
            // Função principal de inicialização
            function initialize() {
                loadFromLocalStorage();
                setupEventListeners();
                populateFilterOptions();
                renderRituals();
                loadingIndicator.style.display = 'none';
            }

            // --- PERSISTÊNCIA DE DADOS (LocalStorage) ---

            function loadFromLocalStorage() {
                const learnedData = localStorage.getItem('learnedRituals');
                if (learnedData) {
                    learnedRituals = new Set(JSON.parse(learnedData));
                }
                const categoryData = localStorage.getItem('customCategories');
                if (categoryData) {
                    customCategories = JSON.parse(categoryData);
                }
            }

            function saveLearned() {
                localStorage.setItem('learnedRituals', JSON.stringify(Array.from(learnedRituals)));
            }
            
            function saveCategories() {
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
            }

            // --- LÓGICA DE RENDERIZAÇÃO ---

            function renderRituals() {
                ritualList.innerHTML = ''; // Limpa a lista
                
                // 1. Filtragem
                let filteredRituals = allRituals.filter(ritual => {
                    if (showOnlyLearned && !learnedRituals.has(ritual.nome_do_ritual)) {
                        return false;
                    }

                    for (const key in activeFilters) {
                        if (activeFilters[key].length > 0) {
                            const ritualValue = key === 'categoria' 
                                ? customCategories[ritual.nome_do_ritual] || 'Sem Categoria'
                                : ritual[key];
                            
                            if (!ritualValue || !activeFilters[key].includes(ritualValue)) {
                                return false;
                            }
                        }
                    }
                    return true;
                });

                // 2. Ordenação
                const elementOrder = ['MORTE', 'SANGUE', 'CONHECIMENTO', 'ENERGIA', 'MEDO', 'VARIA'];
                filteredRituals.sort((a, b) => {
                    switch (currentSort) {
                        case 'level':
                            if (a.nivel !== b.nivel) return a.nivel - b.nivel;
                            return a.nome_do_ritual.localeCompare(b.nome_do_ritual);
                        case 'element':
                            const indexA = elementOrder.indexOf(a.elemento.toUpperCase());
                            const indexB = elementOrder.indexOf(b.elemento.toUpperCase());
                            if (indexA !== indexB) return indexA - indexB;
                            return a.nome_do_ritual.localeCompare(b.nome_do_ritual);
                        case 'alphabetical':
                        default:
                            return a.nome_do_ritual.localeCompare(b.nome_do_ritual);
                    }
                });
                
                // 3. Renderização no DOM
                if (filteredRituals.length === 0) {
                    ritualList.innerHTML = `<p class="text-gray-400 col-span-full text-center py-10">Nenhum ritual encontrado com os filtros atuais.</p>`;
                } else {
                    filteredRituals.forEach(ritual => {
                        const card = createRitualCard(ritual);
                        ritualList.appendChild(card);
                        // Adiciona a classe para a animação de entrada com um pequeno delay
                        setTimeout(() => card.classList.add('ritual-card-enter-active'), 50);
                    });
                }
            }
            
            function createRitualCard(ritual) {
                const isLearned = learnedRituals.has(ritual.nome_do_ritual);
                const category = customCategories[ritual.nome_do_ritual] || 'Nenhuma';
                const elementClass = elementColors[ritual.elemento.toUpperCase()] || 'border-gray-600';
                const elementTextClass = elementTextColors[ritual.elemento.toUpperCase()] || 'text-gray-400';

                const card = document.createElement('div');
                card.className = `ritual-card-enter bg-gray-800 rounded-lg shadow-lg overflow-hidden border-l-4 ${elementClass} transition-all duration-300 hover:shadow-purple-900/40 hover:scale-[1.02]`;

                // Construção do HTML interno do card
                let detailsHTML = '';
                const detailOrder = ['execução', 'alcance', 'alvo', 'duração', 'resistência'];
                detailOrder.forEach(key => {
                    if (ritual[key]) {
                        detailsHTML += `<p class="text-sm"><strong class="font-semibold text-gray-400 capitalize">${key.replace('_', ' ')}:</strong> ${ritual[key]}</p>`;
                    }
                });

                let modificationsHTML = '';
                if (ritual.modificacoes && ritual.modificacoes.length > 0) {
                    modificationsHTML = `
                        <div class="mt-4 pt-3 border-t border-gray-700">
                            <h4 class="font-semibold text-gray-300 mb-2">Modificações:</h4>
                            <ul class="space-y-2 pl-4 list-disc list-inside">
                                ${ritual.modificacoes.map(mod => `
                                    <li>
                                        <strong class="text-purple-400">${mod.versao} (${mod.custo}):</strong>
                                        <span class="text-gray-400">${mod.descricao_modificacao}</span>
                                        ${mod.requisitos ? `<em class="block text-xs text-gray-500">(${mod.requisitos.join(', ')})</em>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="p-4 cursor-pointer ritual-header">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold font-serif tracking-wide text-white">${ritual.nome_do_ritual}</h3>
                                <div class="flex items-center gap-3 text-xs mt-1">
                                    <span class="${elementTextClass} font-semibold">${ritual.elemento} ${ritual.nivel}</span>
                                    <span class="text-gray-500">•</span>
                                    <span class="text-gray-400 italic category-text cursor-pointer hover:text-purple-400" data-ritual-name="${ritual.nome_do_ritual}">${category}</span>
                                </div>
                            </div>
                            <button class="learn-button p-2 rounded-full ${isLearned ? 'bg-yellow-500 text-gray-900' : 'bg-gray-700 text-gray-400'} hover:bg-yellow-400 transition" data-ritual-name="${ritual.nome_do_ritual}" title="${isLearned ? 'Esquecer' : 'Aprender'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="ritual-details hidden px-4 pb-4">
                        <p class="text-gray-300 mb-3">${ritual.descricao}</p>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-400">
                            ${detailsHTML}
                        </div>
                        ${modificationsHTML}
                    </div>
                `;
                
                // Adiciona eventos ao card criado
                card.querySelector('.ritual-header').addEventListener('click', (e) => {
                    // Impede que o clique nos botões propague para o header
                    if (e.target.closest('button') || e.target.closest('.category-text')) return;
                    card.querySelector('.ritual-details').classList.toggle('hidden');
                });

                card.querySelector('.learn-button').addEventListener('click', handleLearnToggle);
                card.querySelector('.category-text').addEventListener('click', handleCategoryEdit);

                return card;
            }

            // --- LÓGICA DE EVENTOS ---
            
            function setupEventListeners() {
                sortOrderSelect.addEventListener('change', (e) => {
                    currentSort = e.target.value;
                    renderRituals();
                });

                filterButton.addEventListener('click', () => filterModal.classList.remove('hidden'));
                closeModalButton.addEventListener('click', () => filterModal.classList.add('hidden'));
                applyFiltersButton.addEventListener('click', handleApplyFilters);
                clearFiltersButton.addEventListener('click', handleClearFilters);

                learnedToggle.addEventListener('click', () => {
                    showOnlyLearned = !showOnlyLearned;
                    learnedToggle.classList.toggle('bg-yellow-500', showOnlyLearned);
                    learnedToggle.classList.toggle('text-gray-900', showOnlyLearned);
                    learnedToggle.classList.toggle('bg-gray-700', !showOnlyLearned);
                    renderRituals();
                });
                
                saveCategoryButton.addEventListener('click', handleSaveCategory);
                cancelCategoryButton.addEventListener('click', () => categoryModal.classList.add('hidden'));

                // Fechar modal ao clicar fora
                filterModal.addEventListener('click', (e) => {
                    if (e.target === filterModal) filterModal.classList.add('hidden');
                });
                categoryModal.addEventListener('click', (e) => {
                    if (e.target === categoryModal) categoryModal.classList.add('hidden');
                });
            }

            function handleLearnToggle(e) {
                const button = e.currentTarget;
                const ritualName = button.dataset.ritualName;
                if (learnedRituals.has(ritualName)) {
                    learnedRituals.delete(ritualName);
                } else {
                    learnedRituals.add(ritualName);
                }
                saveLearned();
                
                // Atualiza o botão visualmente sem re-renderizar tudo
                const isLearned = learnedRituals.has(ritualName);
                button.classList.toggle('bg-yellow-500', isLearned);
                button.classList.toggle('text-gray-900', isLearned);
                button.classList.toggle('bg-gray-700', !isLearned);
                button.classList.toggle('text-gray-400', !isLearned);

                // Se o filtro "Aprendidos" estiver ativo, re-renderiza a lista
                if (showOnlyLearned) {
                    renderRituals();
                }
            }
            
            function handleCategoryEdit(e) {
                currentRitualForCategory = e.currentTarget.dataset.ritualName;
                categoryInput.value = customCategories[currentRitualForCategory] || '';
                categoryModal.classList.remove('hidden');
                categoryInput.focus();
            }

            function handleSaveCategory() {
                const newCategory = categoryInput.value.trim();
                if (newCategory) {
                    customCategories[currentRitualForCategory] = newCategory;
                } else {
                    delete customCategories[currentRitualForCategory];
                }
                saveCategories();
                categoryModal.classList.add('hidden');
                populateFilterOptions(); // Atualiza as opções de filtro com a nova categoria
                renderRituals();
            }

            // --- LÓGICA DE FILTROS ---
            
            function getUniqueValues(key) {
                const values = new Set();
                allRituals.forEach(ritual => {
                    if (ritual[key]) {
                        values.add(ritual[key]);
                    }
                });
                return Array.from(values).sort();
            }
            
            function getUniqueCategories() {
                const values = new Set(Object.values(customCategories));
                values.add('Sem Categoria');
                return Array.from(values).sort();
            }

            function populateFilterOptions() {
                const filterOptionsContainer = document.getElementById('filter-options');
                
                const filterGroups = {
                    'Execução': getUniqueValues('execução'),
                    'Alcance': getUniqueValues('alcance'),
                    'Duração': getUniqueValues('duração'),
                    'Categoria': getUniqueCategories(),
                };
                
                let html = '';
                for (const groupName in filterGroups) {
                    const key = groupName.toLowerCase();
                    html += `<div><h3 class="text-lg font-semibold text-purple-400 mb-2">${groupName}</h3><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">`;
                    filterGroups[groupName].forEach(value => {
                        const isChecked = activeFilters[key] && activeFilters[key].includes(value);
                        html += `
                            <label class="flex items-center space-x-2 bg-gray-700 p-2 rounded-md hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox" data-filter-key="${key}" value="${value}" class="form-checkbox h-4 w-4 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500" ${isChecked ? 'checked' : ''}>
                                <span class="text-sm text-gray-300">${value}</span>
                            </label>
                        `;
                    });
                    html += `</div></div>`;
                }
                filterOptionsContainer.innerHTML = html;
            }
            
            function handleApplyFilters() {
                activeFilters = {};
                const checkboxes = document.querySelectorAll('#filter-options input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    const key = cb.dataset.filterKey;
                    const value = cb.value;
                    if (!activeFilters[key]) {
                        activeFilters[key] = [];
                    }
                    activeFilters[key].push(value);
                });
                filterModal.classList.add('hidden');
                renderRituals();
            }

            function handleClearFilters() {
                activeFilters = {};
                const checkboxes = document.querySelectorAll('#filter-options input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                filterModal.classList.add('hidden');
                renderRituals();
            }

            // Inicia a aplicação
            loadRituals();
        });
    </script>

</body>
</html>
